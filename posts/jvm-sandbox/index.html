<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
    
  <title>透过JVM-SANDBOX源码,了解字节码增强技术 | binbin0325</title>
  <meta name="author" content="Puppet">
  <meta name="description" content="透过JVM-SANDBOX源码,了解字节码增强技术.">
  <meta name="keywords" content="blog,developer,personal">

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="透过JVM-SANDBOX源码,了解字节码增强技术"/>
<meta name="twitter:description" content="透过JVM-SANDBOX源码,了解字节码增强技术."/>

  <meta property="og:title" content="透过JVM-SANDBOX源码,了解字节码增强技术" />
<meta property="og:description" content="透过JVM-SANDBOX源码,了解字节码增强技术." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://binbin0325.github.io/posts/jvm-sandbox/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-07T11:51:54+08:00" />
<meta property="article:modified_time" content="2023-09-07T11:51:54+08:00" />
<meta property="og:see_also" content="https://binbin0325.github.io/posts/same-city-2/" /><meta property="og:see_also" content="https://binbin0325.github.io/posts/same-city-1/" /><meta property="og:see_also" content="https://binbin0325.github.io/posts/jvm-sandbox-1/" /><meta property="og:see_also" content="https://binbin0325.github.io/posts/chaosblade-mem/" /><meta property="og:see_also" content="https://binbin0325.github.io/posts/chaosblade-cpu/" />


  <link rel="stylesheet" href="/css/bootstrap.min.css"  crossorigin="anonymous">
  
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css" rel="stylesheet" type="text/css">

  <link rel="stylesheet" href="/sass/main.css">

  <link rel="stylesheet" href="/zoomjs/zoom.min.css">

  <script src=/js/lazysizes.min.js></script>

  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  

</head>



<body ontouchstart="">
  
  
  <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://binbin0325.github.io/">binbin0325</a>
    </div>
    
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          
          <li><a href="/" title="Home">Home</a></li>
          
          <li><a href="/archive/" title="Archive">Archive</a></li>
          
          <li><a href="/about/" title="About">About</a></li>
          
          <li><a href="https://github.com/binbin0325" title="Github">Github</a></li>
          

          <li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fa fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
    
  </div>
  
</nav>
<script>
  
  
  
  var $body = document.body;
  var $toggle = document.querySelector(".navbar-toggle");
  var $navbar = document.querySelector("#huxblog_navbar");
  var $collapse = document.querySelector(".navbar-collapse");

  var __HuxNav__ = {
    close: function () {
      $navbar.className = " ";
      
      setTimeout(function () {
        
        if ($navbar.className.indexOf("in") < 0) {
          $collapse.style.height = "0px";
        }
      }, 400);
    },
    open: function () {
      $collapse.style.height = "auto";
      $navbar.className += " in";
    },
  };

  
  $toggle.addEventListener("click", function (e) {
    if ($navbar.className.indexOf("in") > 0) {
      __HuxNav__.close();
    } else {
      __HuxNav__.open();
    }
  });

  

  document.addEventListener("click", function (e) {
    if (e.target == $toggle) return;
    if (e.target.className == "icon-bar") return;
    __HuxNav__.close();
  });
</script>
  
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

  
  


<style type="text/css">
  header.intro-header {
    position: relative;
    background-image: url('');
  }
</style>

<header class="intro-header style-text">

  <div class="header-mask"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags">
            
            <a class="tag" href="/tags/jvm/" title="jvm">jvm</a>
            
            <a class="tag" href="/tags/java/" title="java">java</a>
            
            <a class="tag" href="/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" title="字节码">字节码</a>
            
          </div>
          <h1>透过JVM-SANDBOX源码,了解字节码增强技术</h1>
          <h2 class="subheading"></h2>
          <span class="meta">
            Posted by  Binbin Zhang 
            on Thu, Sep 7, 2023
          </span>
        </div>
      </div>
    </div>
  </div>
</header>


  


<article>
  <div class="container">
    <div class="row">

      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              post-container">
        <h1 id="介绍">介绍<a class="anchorjs-link" href="#%e4%bb%8b%e7%bb%8d"></a></h1><p>JVM 沙箱容器是一种 JVM 的非侵入式运行期 AOP 解决方案。通过 JVM-SANDBOX 可以在不重启，不侵入目标 jvm 的前提下对目标方法进行代码增强。</p>
<p>无侵入，类隔离，可插拔，多租户，高兼容是它的特性，JVM-SANDBOX 是相对偏底层的代码增强框架利用它可以搞很多事情，例如线上系统流控、线上系统的请求录制、结果回放，线上故障定位等等。如开源项目 <a href="https://jvm-sandbox-repeater" target="_blank">jvm-sandbox-repeater</a> ， <a href="https://github.com/chaosblade-io/chaosblade-exec-jvm" target="_blank">chaosblade</a> 都是在此基础上构建的，详细介绍可以到 github 中了解，项目地址： <a href="https://github.com/alibaba/jvm-sandbox" target="_blank">https://github.com/alibaba/jvm-sandbox</a></p>
<p>在本文中将通过分析 JVM-SANDBOX 的底层源码，从而了解一个字节码增强框架的核心实现。</p>
<h1 id="架构设计">架构设计<a class="anchorjs-link" href="#%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1"></a></h1><p>JVM Sandbox 内置 HTTP 服务器（Jetty）接受用户指令从而对模块进行管理，例如激活，冻结，刷新等。通过自定义的 ClassLoader 进行类隔离，基于 Java 虚拟机工具接口（JVMTI）,利用 ASM 框架对目标方法进行代码增强。</p>
<p>JVM-SANDBOX 分为多个子项目，其中 agent,core,spy 是主程序库。agent:沙箱启动的代理，core:沙箱内核，spy:沙箱间谍类(代码增强的埋点类)。下图介绍了 sandbox 整体架构中最重要的模块/功能，这些能力都是在 agent,core,spy 三个子项目中提供的。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/2a/2acaec77dc3c285bfd0e661464299b45.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<ol>
<li>
<p>模块控制管理：负责管理 sandbox 自身模块以及使用者自定义模块，例如模块的加载，激活，冻结，卸载</p>
</li>
<li>
<p>事件监听处理：用户自定义模块实现 Event 接口对增强的事件进行自定义处理，等待事件分发处理器的触发。</p>
</li>
<li>
<p>沙箱事件分发处理器：对目标方法增强后会对目标方法追加三个环节，分别为方法调用前 <code>BEFORE</code>、调用后 <code>RETURN</code>、调用抛异常 <code>THROWS</code>、当代码执行到这三个环节时则会由分发器分配到对应的事件监听执行器中执行。</p>
</li>
<li>
<p>代码编织框架：通过 ASM 框架依托于 JVMTI 对目标方法进行字节码修改，从而完成代码增强的能力。</p>
</li>
<li>
<p>检索过滤器：当用户对目标方法创建增强事件时，沙箱会对目标 jvm 中的目标类和方法进行匹配以及过滤。匹配到用户设定目标类和方法进行增强，过滤掉 sandbox 内部的类以及 jvm 认为不可修改的类。</p>
</li>
<li>
<p>加载类检索: 获取到需要增强的类集合依赖检索过滤器模块</p>
</li>
<li>
<p>HTTP 服务器：通过 http 协议与客户端进行通信（<a href="http://sandbox.sh" target="_blank">sandbox.sh</a> 即可理解为客户端）本质是通过 curl 命令下发指令到沙箱的 http 服务器。例如模块的加载，激活，冻结，卸载等指令</p>
</li>
</ol>
<h1 id="相关技术">相关技术<a class="anchorjs-link" href="#%e7%9b%b8%e5%85%b3%e6%8a%80%e6%9c%af"></a></h1><p>在分析之前先简单介绍一些字节码增强框架中会使用到的底层技术，本质上任何一个字节码增强框架都是围绕这些底层技术在上层进行建设。</p>
<h2 id="jvm-ti">JVM TI<a class="anchorjs-link" href="#jvm-ti"></a></h2><p>JVM TI（JVM TOOL INTERFACE，JVM 工具接口）是 JVM 提供的一套对 JVM 进行操作的工具接口。通过 JVMTI 可以实现对 JVM 的多种操作，它通过接口注册各种事件勾子，在 JVM 事件触发的同时触发预定义的勾子，以实现对各个 JVM 事件的响应，事件包括类文件加载、异常产生与捕获、线程启动和结束、进入和退出临界区、成员变量修改、GC 开始和结束、方法调用进入和退出、临界区竞争与等待、VM 启动与退出等等。</p>
<p>当 JVM 加载类文件时会触发类文件加载钩子事件 ClassFileLoadHook，从而触发 Instrumentation 类库中的 ClassFileTransformer (字节码转换器)的 transform 方法，在 transfrom 方法中可以对字节码进行转换</p>
<h2 id="instrumentation">Instrumentation<a class="anchorjs-link" href="#instrumentation"></a></h2><p>Instrumentation 是 JVM 提供的可以在运行时动态修改已加载类的基础库。java agent 是 JVM TI 接口的一种实现,Instrumentation 实例只能通过 agent 的 premain 或者 agentmian 方法的参数中获取。</p>
<p>加载 agent 常见的方式有两种</p>
<ol>
<li>
<p>在启动脚本中增加-javaagent 参数这种方式会伴随着 JVM 一起启动，agent 中需要提供大名鼎鼎的 premain 方法，顾名思义 premain 是在 main 方法运行前执行的，然后才会去运行主程序的 main 方法，这样就要求开发者在应用启动前就必须确认代理的处理逻辑和参数内容等等。这种挂在 agent 方式的好处是如果 agent 启动需要加载大量的类，随着 jvm 启动时直接加载不会导致 JVM 在运行时卡顿或者 CPU 抖动，缺点是不够灵活。</p>
</li>
<li>
<p>利用 Attach API 在 JVM 运行时不需要重启的情况下即可完成挂载，agent 需要提供 agentmain 方法，即插即用的模式非常灵活，Attach API 提供了一种附加到 Java 虚拟机的机制，使用此 API 附加到目标虚拟机并将其工具代理加载到该虚拟机中，本质上就是提供了和目标 jvm 通讯的能力。例如我们常常使用的 jastck,jmap 等命令都是利用 attach api 先与目标 jvm 建立通讯再执行命令。但如果 agent 启动需要加载大量的类可能会导致目标 jvm 出现卡顿，cpu 抖动等情况</p>
</li>
</ol>
<p>在 Instrumentation 接口中提供了多个 api 用来管理和操作字节码。我们重点关注以下几个即可：</p>
<ol>
<li>
<p>addTransformer:注册字节码转换器,当注册一个字节码转换器后，所有的类加载都会经过字节码转换器进行处理。</p>
</li>
<li>
<p>retransformClasses 重新对 JVM 已加载的类进行字节码转换</p>
</li>
<li>
<p>removeTransformer 删除已注册的字节码转换器，删除后新加载的类不会再经过字节码转换器处理，但是已经“增强”过的类还是会继续保留</p>
</li>
</ol>
<h2 id="classfiletransformer">ClassFileTransformer<a class="anchorjs-link" href="#classfiletransformer"></a></h2><p>ClassFileTransformer（字节码转换器）是一个接口，接口中只有 transform 一个方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>  ClassLoader         loader<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>            String              className<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>            Class<span style="color:#ff79c6">&lt;?&gt;</span>            classBeingRedefined<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>            ProtectionDomain    protectionDomain<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span>              classfileBuffer<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    <span style="color:#8be9fd;font-style:italic">throws</span> IllegalClassFormatException<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><p>在 transform 可以返回转换后的字节码 byte[],可以通过 Instrumentation#addTransformer 方法将实现的字节码转换器进行注册，一旦注册后字节码转换器就会在合适的时机被触发。</p>
<ol>
<li>
<p>新加载类的时候，例如 ClassLoader.defineClass</p>
</li>
<li>
<p>重新定义类的时候，例如 Instrumentation.redefineClasses</p>
</li>
<li>
<p>对类重新转换的时候，例如 Instrumentation.retransformClasses</p>
</li>
</ol>
<h2 id="字节码生成">字节码生成<a class="anchorjs-link" href="#%e5%ad%97%e8%8a%82%e7%a0%81%e7%94%9f%e6%88%90"></a></h2><p>在 ClassFileTransformer#transform 方法会返回转换后的字节码 byte[],那如何动态生成字节码呢，这就要提到大名鼎鼎的 ASM 框架了。</p>
<p>ASM 是一个通用的 Java 字节码操作和分析框架。它能够以二进制形式修改已有的类或是动态生成类。很多利用字节码增强技术的开源项目都是基于 ASM 进行构建的，如 CGLIB,Groovy,Kotlin 编译器等等，ASM 提供了一些常见的字节码转换和分析算法，从中可以构建定制的复杂转换和代码分析工具；几个核心的类：</p>
<ul>
<li>
<p>ClassReader：此类主要功能就是读取字节码文件，然后把读取的数据通知 ClassVisitor；</p>
</li>
<li>
<p>ClassVisitor：用于生成和转换编译类的 ASM API 基于 ClassVisitor 抽象类，接收 ClassReader 发出的对 method 的访问请求，并且替换为另一个自定义的 MethodVisitor</p>
</li>
<li>
<p>ClassWriter：其继承于 ClassVisitor，主要用来生成类；</p>
</li>
</ul>
<p>大体的执行流程是首先需要加载原 Class 文件，然后通过访问者模式访问所有元素，在访问的过程中对各元素进行改造，最后重新生成一个字节码的 byte[]，如图:</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/8d/8dbbdcbf8a162cf5271aee0e3da3fbf4.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="classloader">ClassLoader<a class="anchorjs-link" href="#classloader"></a></h2><p>沙箱中另一个特性类隔离是通过实现自定义的 classLoader 来完成的，ClassLoader（类加载器），在 java 中所有的类必须通过类加载器正确加载后才能运行，类加载器虽然只用于实现类的加载动作，但它在 Java 程序中起到的作用却远超类加载阶段。</p>
<p>对于任意一个类，都必须由加载它的类加载器和这个类本身一起共同确立其在 Java 虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。这句话可以表达得更通俗一些:比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个 Class 文件，被同一个 Java 虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等。</p>
<h3 id="加载器种类">加载器种类<a class="anchorjs-link" href="#%e5%8a%a0%e8%bd%bd%e5%99%a8%e7%a7%8d%e7%b1%bb"></a></h3><p>在 java8 中默认 jvm 会提供三个类加载器，分别是</p>
<ol>
<li>
<p>启动类加载器(Bootstrap Class Loader):这个类加载器负责加载存放在 &lt;JAVA_HOME&gt;\lib 目录，或者被-Xbootclasspath 参数所指定的路径中存放的，而且是 Java 虚拟机能够 识别的(按照文件名识别，如 rt .jar、t ools.jar，名字不符合的类库即使放在 lib 目录中也不会被加载)类 库加载到虚拟机的内存中</p>
</li>
<li>
<p>扩展类加载器(Extension Class Loader):这个类加载器是在类 sun.misc.Launcher$ExtClassLoader 中以 Java 代码的形式实现的。它负责加载&lt;JAVA_HOM E&gt;\lib\ext 目录中，或者被 java.ext.dirs 系统变量所 指定的路径中所有的类库。</p>
</li>
<li>
<p>应用程序类加载器(Application Class Loader):这个类加载器由 sun.misc.Launcher$App ClassLoader 来实现。由于应用程序类加载器是 ClassLoader 类中的 getSystem- ClassLoader()方法的返回值，所以有些场合中也称它为“系统类加载器”。它负责加载用户类路径 (ClassPath)上所有的类库，开发者同样可以直接在代码中使用这个类加载器。如果应用程序中没有 自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</p>
</li>
<li>
<p>自定义类加载器:顾名思义是由开发者自定义的类加载器</p>
</li>
</ol>
<h3 id="双亲委派模型">双亲委派模型<a class="anchorjs-link" href="#%e5%8f%8c%e4%ba%b2%e5%a7%94%e6%b4%be%e6%a8%a1%e5%9e%8b"></a></h3><p>上面介绍了三个系统提供的类加载器，那么他们之间以及和自定义类加载器是如何协作的呢？</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/9e/9ede7a756640afb12cd1b3024fa14d2f.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>各种类加载器的协作关系如图，这种层次关系就是类加载器的“双亲委派模型”，除了顶层的启动类加载器以外，其余的类加载器都应有自己的父类加载器。</p>
<p>双亲委派模型的工作过程是:如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到最顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求(它的搜索范围中没有找到所需的类)时，子加载器才会尝试自己去完成加载。</p>
<p>使用双亲委派模型来组织类加载器之间的关系，一个显而易见的好处就是 Java 中的类随着它的类加载器一起具备了一 种带有优先级的层次关系。例如类 java. lang.Object，它存放在 rt . jar 之中，无论哪一个类加载器要加载这个类，最终都是委派给处于模型最顶端的启动类加载器进行加载，因此 Object 类 在程序的各种类加载器环境中都能够保证是同一个类。反之，如果没有使用双亲委派模型，都由各个 类加载器自行去加载的话，如果用户自己也编写了一个名为 java.lang.Object 的类，并放在程序的 ClassPath 中，那系统中就会出现多个不同的 Object 类，Java 类型体系中最基础的行为也就无从保证，应用程序将会变得一片混乱 。</p>
<h3 id="自定义类加载器">自定义类加载器<a class="anchorjs-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8"></a></h3><p>通常情况下自定义类加载器只需要继承 URLClassLoader，重写 findClass 方法即可，当然也可以直接继承 ClassLoader,不过 ClassLoader 只能加载 classpath 下面的类，而 URLClassLoader 可以加载任意路径下的类。</p>
<p>URLClassLoader 是 ClassLoader 的子类，它用于从指向 JAR 文件和目录的 URL 的搜索路径加载类和资源。也就是说通过 URLClassLoader 就可以加载指定 jar 中的 class 到内存中。</p>
<h3 id="沙箱类隔离策略">沙箱类隔离策略<a class="anchorjs-link" href="#%e6%b2%99%e7%ae%b1%e7%b1%bb%e9%9a%94%e7%a6%bb%e7%ad%96%e7%95%a5"></a></h3><p>在了解了 classloader 相关知识后，我们看一下 jvm-sandbox 提供的官方类隔离策略图</p>
<p>在沙箱中自定义了 SandboxClassLoader 以及 ModuleJarClassLoader 来分别加载沙箱内部类和模块中的类,sandbox agent 则是由 AppClassLoader 进行加载的,而 sandbox spy 间谍类是用 BootstrapClassLoader 进行加载，目的就是利用双亲委派加载模型,保证间谍类可以正确的被目标 JVM 加载,从而植入到目标 jvm 中完成与业务代码的交互。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/17/179fb2b2319a4b85bc4dd7311d17c045.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="spi">SPI<a class="anchorjs-link" href="#spi"></a></h2><p>SPI 全称 Service Provider Interface，是 Java 提供的一套用来被第三方实现或者扩展的 API，它可以用来启用框架扩展和替换组件。Java SPI 实际上是“基于接口的编程＋策略模式＋配置文件”组合实现的动态加载机制，提供了通过 interface 寻找 implement 的方法。类似于 IOC 的思想，将装配的控制权移到程序之外，从而实现解耦。</p>
<p>关于 SPI 的底层实现在这里就不分析了，在沙箱中自定义模块的实现则是利用了 SPI 机制，当我们自定义模块除了要实现 Module interface，还需要按照 SPI 的约定在 resource/META-services 下以 com.alibaba.jvm.sandbox.api.Module 为文件名，文件内容则是 Module 的实现类路径。当使用 SPI 加载实现类时需要传递一个 classLoader,这个 classLoader 是 moduleClassLoader，moduleClassLoader 中是继承自 URLClassLoader，SPI 加载类则查找当前 classLoader 对应的资源路径，从而找到匹配 Module interface 路径的文件，然后加载对应的实现类。</p>
<p>适应场景：调用者根据需要，使用、扩展或替换实现策略。</p>
<h1 id="启动过程">启动过程<a class="anchorjs-link" href="#%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b"></a></h1><p>在 sandbox 启动过程中涉及到 Agent 挂载,自定义 classloader 加载 sandbox 内部类，初始化 http 服务器，模块的加载以及初始化。</p>
<h2 id="挂载-agent">挂载 Agent<a class="anchorjs-link" href="#%e6%8c%82%e8%bd%bd-agent"></a></h2><p>JVM-SANDBOX 对两种 agent 的挂载模式都支持。</p>
<ol>
<li>
<p>-javaagent 启动脚本中直接挂载</p>
</li>
<li>
<p>利用 attach api 在运行时挂载</p>
</li>
</ol>
<p>如果启动时直接加载则直接在目标 JVM 的启动脚本中增加-javaagent 指定 sandbox-agent.jar 即可。当执行./sandbox -p pid(目标 jvm 进程 id)是使用的 attach api 方式进行 agent 的挂载</p>
<p>在运行上述指令时执行的是 <a href="http://sandbox.sh" target="_blank">sandbox.sh</a> 中 attach_jvm func，在 attach_jvm 中是通过 java -jar 启动 sandbox-core,并指定了 sandbox-agent.jar 的路径地址等参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>function <span style="color:#50fa7b">attach_jvm</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>  # attach target jvm
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  <span style="color:#f1fa8c">&#34;${SANDBOX_JAVA_HOME}/bin/java&#34;</span> \
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    $<span style="color:#ff79c6">{</span>SANDBOX_JVM_OPS<span style="color:#ff79c6">}</span> \
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#ff79c6">-</span>jar <span style="color:#f1fa8c">&#34;${SANDBOX_LIB_DIR}/sandbox-core.jar&#34;</span> \
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#f1fa8c">&#34;${TARGET_JVM_PID}&#34;</span> \
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#f1fa8c">&#34;${SANDBOX_LIB_DIR}/sandbox-agent.jar&#34;</span> \
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#f1fa8c">&#34;home=${SANDBOX_HOME_DIR};token=${token};server.ip=${TARGET_SERVER_IP};server.port=${TARGET_SERVER_PORT};namespace=${TARGET_NAMESPACE}&#34;</span> <span style="color:#ff79c6">||</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    exit_on_err <span style="color:#bd93f9">1</span> <span style="color:#f1fa8c">&#34;attach JVM ${TARGET_JVM_PID} fail.&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>在 sandbox-core 项目的 pom.xml 文件中指定了 core 程序的启动类 CoreLauncher.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#ff79c6">&lt;</span>manifest<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    <span style="color:#ff79c6">&lt;</span>mainClass<span style="color:#ff79c6">&gt;</span>com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alibaba</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">jvm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sandbox</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">core</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">CoreLauncher</span><span style="color:#ff79c6">&lt;/</span>mainClass<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#ff79c6">&lt;/</span>manifest<span style="color:#ff79c6">&gt;</span>
</span></span></code></pre></div><p>在 CoreLauncher 中利用 Attach api 对目标 jvm 进行 jvm-sandbox agent 挂载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">attachAgent</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String targetJvmPid<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>                         <span style="color:#8be9fd;font-style:italic">final</span> String agentJarPath<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>                         <span style="color:#8be9fd;font-style:italic">final</span> String cfg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        vmObj <span style="color:#ff79c6">=</span> VirtualMachine<span style="color:#ff79c6">.</span><span style="color:#50fa7b">attach</span><span style="color:#ff79c6">(</span>targetJvmPid<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>vmObj <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>            vmObj<span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadAgent</span><span style="color:#ff79c6">(</span>agentJarPath<span style="color:#ff79c6">,</span> cfg<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="加载-agent">加载 Agent<a class="anchorjs-link" href="#%e5%8a%a0%e8%bd%bd-agent"></a></h2><p>在 agent 项目中只有两个 java 文件：AgentLaucher.java、SandboxClassLoader.java</p>
<p>在 agent 项目的 pom.xml 中指定了程序的 Premain-Class 以及 Agent-Class,分别对应上面两种 agent 的挂载方式，当使用-javaagent 挂载 agent 时则会加载 Premain-Class 的 premain 方法，当使用 Attach api 挂载 agent 时则会加载 Agent-Class 的 agentmain 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#ff79c6">&lt;</span>manifestEntries<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    <span style="color:#ff79c6">&lt;</span>Premain<span style="color:#ff79c6">-</span>Class<span style="color:#ff79c6">&gt;</span>com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alibaba</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">jvm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sandbox</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">agent</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">AgentLauncher</span><span style="color:#ff79c6">&lt;/</span>Premain<span style="color:#ff79c6">-</span>Class<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#ff79c6">&lt;</span>Agent<span style="color:#ff79c6">-</span>Class<span style="color:#ff79c6">&gt;</span>com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alibaba</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">jvm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sandbox</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">agent</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">AgentLauncher</span><span style="color:#ff79c6">&lt;/</span>Agent<span style="color:#ff79c6">-</span>Class<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    <span style="color:#ff79c6">&lt;</span>Can<span style="color:#ff79c6">-</span>Redefine<span style="color:#ff79c6">-</span>Classes<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">&lt;/</span>Can<span style="color:#ff79c6">-</span>Redefine<span style="color:#ff79c6">-</span>Classes<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    <span style="color:#ff79c6">&lt;</span>Can<span style="color:#ff79c6">-</span>Retransform<span style="color:#ff79c6">-</span>Classes<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">&lt;/</span>Can<span style="color:#ff79c6">-</span>Retransform<span style="color:#ff79c6">-</span>Classes<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span><span style="color:#ff79c6">&lt;/</span>manifestEntries<span style="color:#ff79c6">&gt;</span>
</span></span></code></pre></div><p>在两个 main 方法中接收的参数是相同的分别为：String featureString 和 Instrumentation inst</p>
<ol>
<li>
<p>String featureString 是脚本中的执行脚本执行 attach 时传递过来的参数 如 sandbox 路径地址，token，namspace(租户)等</p>
</li>
<li>
<p>Instrumentation 是 JVM 提供的可以在运行时动态修改已加载类的基础库，获取 Instrumentation 实例只能通过 premain 或者 agentmian 方法参数中获取。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#6272a4">//启动加载 -javaagent
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">premain</span><span style="color:#ff79c6">(</span>String featureString<span style="color:#ff79c6">,</span> Instrumentation inst<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    LAUNCH_MODE <span style="color:#ff79c6">=</span> LAUNCH_MODE_AGENT<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    install<span style="color:#ff79c6">(</span>toFeatureMap<span style="color:#ff79c6">(</span>featureString<span style="color:#ff79c6">),</span> inst<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#6272a4">//动态加载 attach api
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">agentmain</span><span style="color:#ff79c6">(</span>String featureString<span style="color:#ff79c6">,</span> Instrumentation inst<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    LAUNCH_MODE <span style="color:#ff79c6">=</span> LAUNCH_MODE_ATTACH<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> Map<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> featureMap <span style="color:#ff79c6">=</span> toFeatureMap<span style="color:#ff79c6">(</span>featureString<span style="color:#ff79c6">);</span> <span style="color:#6272a4">//解析惨参数
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#6272a4"></span>    writeAttachResult<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            getNamespace<span style="color:#ff79c6">(</span>featureMap<span style="color:#ff79c6">),</span> <span style="color:#6272a4">//获取租户所属 namespace
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#6272a4"></span>            getToken<span style="color:#ff79c6">(</span>featureMap<span style="color:#ff79c6">),</span> <span style="color:#6272a4">//获取 token
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#6272a4"></span>            install<span style="color:#ff79c6">(</span>featureMap<span style="color:#ff79c6">,</span> inst<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>无论是哪种方式挂载 agent 核心都在 install 方法中，install 中是开始加载 agent 的业务逻辑</p>
<h2 id="初始化-agent">初始化 Agent<a class="anchorjs-link" href="#%e5%88%9d%e5%a7%8b%e5%8c%96-agent"></a></h2><p>在 install 方法中完成对 agent 的初始化，在初始化的过程中使用到了自定义的 SandboxClassLoader 对沙箱类进行加载，实现沙箱内部类与业务类隔离。</p>
<h3 id="spy-间谍类">Spy 间谍类<a class="anchorjs-link" href="#spy-%e9%97%b4%e8%b0%8d%e7%b1%bb"></a></h3><p>在 install 中首先会利用 Instrumentation 实例将 sandbox-spy.jar 添加到 BootstrapClassLoader 的搜索范围内。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#6272a4">// 将 Spy 注入到 BootstrapClassLoader
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#6272a4"></span>inst<span style="color:#ff79c6">.</span><span style="color:#50fa7b">appendToBootstrapClassLoaderSearch</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> JarFile<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> File<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        getSandboxSpyJarPath<span style="color:#ff79c6">(</span>home<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        <span style="color:#6272a4">// SANDBOX_SPY_JAR_PATH
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#6272a4"></span><span style="color:#ff79c6">)));</span>
</span></span></code></pre></div><p>为什么这么做,在解释前我们先了解下 Spy 间谍类是什么。在沙箱的世界观中，任何一个 Java 方法的调用都可以分解为 BEFORE、RETURN 和 THROWS 三个环节，由此在三个环节上引申出对应环节的事件探测和流程控制机制。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#6272a4">// BEFORE
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#6272a4"></span><span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>   <span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#6272a4">    * do something...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#6272a4">    */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#6272a4">// RETURN
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#6272a4">// THROWS
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>而 Spy 间谍类就是实现了 before，return,throws 等钩子函数。当将 Spy 间谍类买点到业务代码中时，触发类加载机制时利用双亲委派模型则可以层层向上查找，在 BootstrapClassLoader 中就可以将 Spy 间谍类正确加载，而在 Spy 的间谍类中内置了沙箱的 SpyHandler。这样就完成了目标类和沙箱内核的通讯。本质的类增强策略如下图:</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/1f/1f21d81be962a2348903b3d462998b22.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>在加载 agent 执行 install 方法中首先会将 Spy 间谍类追加到 BootstrapClassLoader 的搜索范围内，这样当对业务代码增强时通过 classloader 双亲委派机制，Spy 间谍类一定会被正确加载，Spy 间谍类会将 before，return,throws 等钩子函数顺利的注入到业务代码中。</p>
<h3 id="sandboxclassloader">SandBoxClassLoader<a class="anchorjs-link" href="#sandboxclassloader"></a></h3><p>在将 Spy 间谍类追加到 BootstrapClassLoader 中后创建 SandBoxClassLoader，目的是使用自定义的 classLoader 可以尽量减少对目标 JVM 的侵入。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">final</span> ClassLoader sandboxClassLoader <span style="color:#ff79c6">=</span> loadOrDefineClassLoader<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        namespace<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        getSandboxCoreJarPath<span style="color:#ff79c6">(</span>home<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        <span style="color:#6272a4">// SANDBOX_CORE_JAR_PATH
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#6272a4"></span><span style="color:#ff79c6">);</span>
</span></span></code></pre></div><p>在自定义的 SandboxClassLoader 中加载类破坏了双亲委派模型，首先让自身加载，如果自身加载失败后再向上委托加载。这样做的目的是明确知道 SandboxClassLoader 只会加载沙箱 jar 文件的类，而这些 jia 文件路径并不在目标的 JVM 的 ClasssLoader 可搜索的路径上，所以向上委托加载无任何意义，破坏掉双亲委派模型，优先自身加载性能更好。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span> @Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> loadClass<span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> resolve<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> loadedClass <span style="color:#ff79c6">=</span> findLoadedClass<span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>loadedClass <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            <span style="color:#ff79c6">return</span> loadedClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            Class<span style="color:#ff79c6">&lt;?&gt;</span> aClass <span style="color:#ff79c6">=</span> findClass<span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>resolve<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                resolveClass<span style="color:#ff79c6">(</span>aClass<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>            <span style="color:#ff79c6">return</span> aClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">,</span> resolve<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="启动-http-服务">启动 HTTP 服务<a class="anchorjs-link" href="#%e5%90%af%e5%8a%a8-http-%e6%9c%8d%e5%8a%a1"></a></h3><p>在创建完 SandboxClassLoader 后则会利用 SandboxClassLoader 加载 core.jar 中的代理类（ProxyCoreServer），然后反射调用 ProxyCoreServer 的 bind 方法来初始化 HTTP 服务以及加载所有模块。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> CoreConfigure cfg<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> Instrumentation inst<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">cfg</span> <span style="color:#ff79c6">=</span> cfg<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        initializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">initProcess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Initializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Processor</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>            @Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">process</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Throwable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;initializing server. cfg={}&#34;</span><span style="color:#ff79c6">,</span> cfg<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                jvmSandbox <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> JvmSandbox<span style="color:#ff79c6">(</span>cfg<span style="color:#ff79c6">,</span> inst<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                initHttpServer<span style="color:#ff79c6">();</span> <span style="color:#6272a4">//初始化 http server
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#6272a4"></span>                initJettyContextHandler<span style="color:#ff79c6">();</span> <span style="color:#6272a4">//初始化 jetty context 处理器
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#6272a4"></span>                httpServer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">();</span><span style="color:#6272a4">// 启动 http server
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#6272a4">// 初始化加载所有的模块
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>            jvmSandbox<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getCoreModuleManager</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">reset</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;reset occur error when initializing.&#34;</span><span style="color:#ff79c6">,</span> cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        <span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>在 bind 中会初始化 HttpServer 并初始化上下文处理器，在初始化上下文处理器中将会绑定/module/http/*的 Servlet 为 ModuleHttpServlet，这样的话当我们对模块进行操作的话都会先经过 ModuleHttpServlet 进行匹配然后分发到具体的模块中执行命令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initJettyContextHandler</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>     <span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#6272a4">// module-http-servlet
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> String pathSpec <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/module/http/*&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;initializing http-handler. path={}&#34;</span><span style="color:#ff79c6">,</span> contextPath <span style="color:#ff79c6">+</span> pathSpec<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    context<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addServlet</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            <span style="color:#ff79c6">new</span> ServletHolder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ModuleHttpServlet<span style="color:#ff79c6">(</span>cfg<span style="color:#ff79c6">,</span> jvmSandbox<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getCoreModuleManager</span><span style="color:#ff79c6">())),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            pathSpec
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    httpServer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setHandler</span><span style="color:#ff79c6">(</span>context<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="小结">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93"></a></h2><p>在 sandbox 启动时首先需要利用 Attach API 或者 java -javaagent 挂在 agent。agent 需要提供对应的 agetmain 方法或者 premain 方法，在 agent 对应的 main 方法中进行初始化。</p>
<p>首先将 spy 间谍类追加到 BootstrapClassLoader 中为后面代码增强做准备，最终目的是让目标 JVM 业务类可以和沙箱进行通讯，然后创建自定义的 SandboxClassLoader 用来加载沙箱内部类从而实现类隔离，最后启动 HttpServer 并初始化对应的 Servlet,启动完成后加载并初始化所有 module</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/1a/1a2c85740a971d2c0bc5256ca1d0ee4a.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h1 id="模块管理">模块管理<a class="anchorjs-link" href="#%e6%a8%a1%e5%9d%97%e7%ae%a1%e7%90%86"></a></h1><p>目前在 sandbox 中有两个地方会存储模块:</p>
<ol>
<li>
<p>$sandbox_home/module/沙箱系统模块目录，由配置项 system_module 进行定义。用于存放沙箱通用的管理模块，比如用于沙箱模块管理功能的 module-mgr 模块，未来的模块运行质量监控模块、安全校验模块也都将存放在此处，跟随沙箱的发布而分发。系统模块不受刷新(-f)、**强制刷新(-F)功能的影响，只有容器重置(-R)**能让沙箱重新加载系统模块目录下的所有模块。</p>
</li>
<li>
<p>$sandbox_home/sandbox-module/沙箱用户模块目录，由 sandbox.properties 的配置项 user_module 进行定义，默认为${HOME}/.sandbox-module/。一般用于存放用户自研的模块。自研的模块经常要面临频繁的版本升级工作，当需要进行模块动态热插拔替换的时候，可以通过**刷新(-f)或强制刷新(-F)**来完成重新加载。</p>
</li>
</ol>
<h2 id="模块的生命周期">模块的生命周期<a class="anchorjs-link" href="#%e6%a8%a1%e5%9d%97%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f"></a></h2><p>在沙箱中模块一共有四种状态</p>
<ol>
<li>
<p>【加载模块】被沙箱正确加载，沙箱将会允许模块进行命令相应、代码插桩等动作</p>
</li>
<li>
<p>【激活模块】加载成功后默认是冻结状态，需要代码主动进行激活。模块只有在激活状态下才能监听到沙箱事件</p>
</li>
<li>
<p>【冻结模块】进入到冻结状态之后，之前侦听的所有沙箱事件都将被屏蔽。需要注意的是，冻结的模块不会退回事件侦听的代码插桩，只有 delete()、wathcing()或者模块被卸载的时候插桩代码才会被清理</p>
</li>
<li>
<p>【卸载沙箱】不会再看到该模块，之前给该模块分配的所有资源都将会被回收，包括模块已经侦听事件的类都将会被移除掉侦听插桩，干净利落不留后遗症</p>
</li>
</ol>
<p>模块的状态分别对应着模块的生命周期，一个模块在沙箱中的生命周期如下:</p>
<p>MODULE_LOAD(模块加载)，MODULE_UNLOAD(模块卸载)，MODULE_ACTIVE(模块激活)，MODULE_FROZE(模块冻结)，MODULE_LOAD_COMPLETED(模块加载完成)</p>
<h2 id="模块加载">模块加载<a class="anchorjs-link" href="#%e6%a8%a1%e5%9d%97%e5%8a%a0%e8%bd%bd"></a></h2><p>在启动过程中初始化 http server 的最后一步是加载并初始化所有 module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span> jvmSandbox<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getCoreModuleManager</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">reset</span><span style="color:#ff79c6">();</span>
</span></span></code></pre></div><p>我们来看一下加载 module 都做了哪些事情，因为这里是初始化操作，所以在 reset 中首先强制卸载所有模块，避免之前有已加载的模块。然后遍历 moduleLibDirArray 加载模块，moduleLibDirArray 指的是模块的存储路径，</p>
<p>在 reset 中会遍历这两个路径对路径下的模块进行加载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> CoreModuleManager <span style="color:#50fa7b">reset</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> ModuleException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;resetting all loaded modules:{}&#34;</span><span style="color:#ff79c6">,</span> loadedModuleBOMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">keySet</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#6272a4">// 1. 强制卸载所有模块
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#6272a4"></span>    unloadAll<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#6272a4">// 2. 加载所有模块
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> File moduleLibDir <span style="color:#ff79c6">:</span> moduleLibDirArray<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#6272a4">// 用户模块加载目录，加载用户模块目录下的所有模块
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 对模块访问权限进行校验
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>moduleLibDir<span style="color:#ff79c6">.</span><span style="color:#50fa7b">exists</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">&amp;&amp;</span> moduleLibDir<span style="color:#ff79c6">.</span><span style="color:#50fa7b">canRead</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            <span style="color:#ff79c6">new</span> ModuleLibLoader<span style="color:#ff79c6">(</span>moduleLibDir<span style="color:#ff79c6">,</span> cfg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLaunchMode</span><span style="color:#ff79c6">())</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">load</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                            <span style="color:#ff79c6">new</span> InnerModuleJarLoadCallback<span style="color:#ff79c6">(),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                            <span style="color:#ff79c6">new</span> InnerModuleLoadCallback<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;module-lib not access, ignore flush load this lib. path={}&#34;</span><span style="color:#ff79c6">,</span> moduleLibDir<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>在上面经过方法层层调用会走到 ModuleJarLoader.java 的 load 方法中，这里面接收的参数则是上面的 InnerModuleLoadCallback 对象，在这个方法中我们可以看到又创建了一个 ModuleJarClassLoader，通过字面意思理解这个 ClassLoader 主要是为了加载模块的类.</p>
<p>创建后并指定了当前加载模块的线程使用 ModuleJarClassLoader，这样的话后面真正加载模块中的类时即可默认使用 ModuleJarClassLoader 了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">load</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> ModuleLoadCallback mCb<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#8be9fd">boolean</span> hasModuleLoadedSuccessFlag <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    ModuleJarClassLoader moduleJarClassLoader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;prepare loading module-jar={};&#34;</span><span style="color:#ff79c6">,</span> moduleJarFile<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        moduleJarClassLoader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ModuleJarClassLoader<span style="color:#ff79c6">(</span>moduleJarFile<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> ClassLoader preTCL <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContextClassLoader</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">setContextClassLoader</span><span style="color:#ff79c6">(</span>moduleJarClassLoader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            hasModuleLoadedSuccessFlag <span style="color:#ff79c6">=</span> loadingModules<span style="color:#ff79c6">(</span>moduleJarClassLoader<span style="color:#ff79c6">,</span> mCb<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>            Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">setContextClassLoader</span><span style="color:#ff79c6">(</span>preTCL<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="modulejarclassloader">ModuleJarClassLoader<a class="anchorjs-link" href="#modulejarclassloader"></a></h3><p>ModuleJarClassLoader 继承自一个叫 RoutingURLClassLoader，它的构造方法则是调用父类 RoutingURLClassLoader 的构造方法并传递了两个参数，两个参数都是待加载模块 jar 文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ModuleJarClassLoader</span> <span style="color:#8be9fd;font-style:italic">extends</span> RoutingURLClassLoader <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#50fa7b">ModuleJarClassLoader</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> File moduleJarFile<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                                 <span style="color:#8be9fd;font-style:italic">final</span> File tempModuleJarFile<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                <span style="color:#ff79c6">new</span> URL<span style="color:#ff79c6">[]{</span><span style="color:#ff79c6">new</span> URL<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;file:&#34;</span> <span style="color:#ff79c6">+</span> tempModuleJarFile<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getPath</span><span style="color:#ff79c6">())},</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                <span style="color:#ff79c6">new</span> Routing<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                        ModuleJarClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">(),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                        <span style="color:#f1fa8c">&#34;^com\\.alibaba\\.jvm\\.sandbox\\.api\\..*&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>                        <span style="color:#f1fa8c">&#34;^javax\\.servlet\\..*&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                        <span style="color:#f1fa8c">&#34;^javax\\.annotation\\.Resource.*$&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="routingurlclassloader">RoutingURLClassLoader<a class="anchorjs-link" href="#routingurlclassloader"></a></h3><p>RoutingURLClassLoader 中我们重点关注下构造方法和 loadClass 方法，在构造方法中接收了 ModuleJarClassLoader 传递过来的要加载的模块 jar 路径以及 Routing 对象，Routing 对象中包含了 ModuleJarClassLoader 的 ClassLoader（SandboxClassLoader）以及一些正则匹配的类路径。</p>
<p>通过 loadClass 方法的实现不难看出，当要加载的 className 正则匹配成功则直接委托 SandboxClassLoader 加载，这样的好处是不需要每个模块都加载一遍这些通用的类。当要加载的 className 正则匹配失败，则用自身进行加载，如果加载不成功则向上继续委托加载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RoutingURLClassLoader</span> <span style="color:#8be9fd;font-style:italic">extends</span> URLClassLoader <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger logger <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>RoutingURLClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> ClassLoadingLock classLoadingLock <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ClassLoadingLock<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> Routing<span style="color:#ff79c6">[]</span> routingArray<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">RoutingURLClassLoader</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> URL<span style="color:#ff79c6">[]</span> urls<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                                 <span style="color:#8be9fd;font-style:italic">final</span> Routing<span style="color:#ff79c6">...</span> routingArray<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>urls<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">routingArray</span> <span style="color:#ff79c6">=</span> routingArray<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    @Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#8be9fd;font-style:italic">protected</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> loadClass<span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String javaClassName<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> resolve<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>      <span style="color:#ff79c6">return</span> classLoadingLock<span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadingInLock</span><span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> ClassLoadingLock<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ClassLoading</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        @Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        <span style="color:#8be9fd;font-style:italic">public</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> loadClass<span style="color:#ff79c6">(</span>String javaClassName<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            <span style="color:#6272a4">// 优先查询类加载路由表,如果命中路由规则,则优先从路由表中的 ClassLoader 完成类加载
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>ArrayUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isNotEmpty</span><span style="color:#ff79c6">(</span>routingArray<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> Routing routing <span style="color:#ff79c6">:</span> routingArray<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>routing<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isHit</span><span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                        <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                    <span style="color:#8be9fd;font-style:italic">final</span> ClassLoader routingClassLoader <span style="color:#ff79c6">=</span> routing<span style="color:#ff79c6">.</span><span style="color:#50fa7b">classLoader</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>                        <span style="color:#ff79c6">return</span> routingClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>                    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>                        <span style="color:#6272a4">// 如果在当前 routingClassLoader 中找不到应该优先加载的类(应该不可能，但不排除有就是故意命名成同名类)
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 此时应该忽略异常，继续往下加载
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// ignore...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>            <span style="color:#6272a4">// 先走一次已加载类的缓存，如果没有命中，则继续往下加载
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span><span style="color:#6272a4"></span>            <span style="color:#8be9fd;font-style:italic">final</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> loadedClass <span style="color:#ff79c6">=</span> findLoadedClass<span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>loadedClass <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>                <span style="color:#ff79c6">return</span> loadedClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>                Class<span style="color:#ff79c6">&lt;?&gt;</span> aClass <span style="color:#ff79c6">=</span> findClass<span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>resolve<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>                    resolveClass<span style="color:#ff79c6">(</span>aClass<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>                <span style="color:#ff79c6">return</span> aClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>                DelegateBizClassLoader delegateBizClassLoader <span style="color:#ff79c6">=</span> BusinessClassLoaderHolder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBussinessClassLoader</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>                    <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> delegateBizClassLoader<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>                        <span style="color:#ff79c6">return</span> delegateBizClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">,</span>resolve<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>                    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>                    <span style="color:#6272a4">//忽略异常，继续往下加载
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>                <span style="color:#ff79c6">return</span> RoutingURLClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span>javaClassName<span style="color:#ff79c6">,</span> resolve<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>    <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>在 ModuleJarLoader.java 的 load 方法中除了创建 ModuleJarClassLoader，还调用了 loadModules 方法，在方法中利用 ServiceLoader(SPI)加载 Module 接口的实现，然后遍历检查接口实现是否符合要求，例如是否有@Infomation 注解，模块唯一 id 是否合法，模块的启动方式是否和沙箱的启动方式一致。当这些前置检查都通过后，调用 ModuleLoadCallback.load 进行模块的加载。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">loadingModules</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> ModuleJarClassLoader moduleClassLoader<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>                               <span style="color:#8be9fd;font-style:italic">final</span> ModuleLoadCallback mCb<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> loadedModuleUniqueIds <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LinkedHashSet<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> ServiceLoader<span style="color:#ff79c6">&lt;</span>Module<span style="color:#ff79c6">&gt;</span> moduleServiceLoader <span style="color:#ff79c6">=</span> ServiceLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">load</span><span style="color:#ff79c6">(</span>Module<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> moduleClassLoader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> Iterator<span style="color:#ff79c6">&lt;</span>Module<span style="color:#ff79c6">&gt;</span> moduleIt <span style="color:#ff79c6">=</span> moduleServiceLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">iterator</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>moduleIt<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> Module module<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            module <span style="color:#ff79c6">=</span> moduleIt<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;loading module instance failed: instance occur error, will be ignored. module-jar={}&#34;</span><span style="color:#ff79c6">,</span> moduleJarFile<span style="color:#ff79c6">,</span> cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> classOfModule <span style="color:#ff79c6">=</span> module<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        <span style="color:#6272a4">// 判断模块是否实现了@Information 标记
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>classOfModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAnnotationPresent</span><span style="color:#ff79c6">(</span>Information<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;loading module instance failed: not implements @Information, will be ignored. class={};module-jar={};&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                    classOfModule<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                    moduleJarFile
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>            <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>            <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> Information info <span style="color:#ff79c6">=</span> classOfModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAnnotation</span><span style="color:#ff79c6">(</span>Information<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> String uniqueId <span style="color:#ff79c6">=</span> info<span style="color:#ff79c6">.</span><span style="color:#50fa7b">id</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>        <span style="color:#6272a4">// 判断模块 ID 是否合法
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>StringUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isBlank</span><span style="color:#ff79c6">(</span>uniqueId<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;loading module instance failed: @Information.id is missing, will be ignored. class={};module-jar={};&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>                    classOfModule<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>                    moduleJarFile
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>            <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>            <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>        <span style="color:#6272a4">// 判断模块要求的启动模式和容器的启动模式是否匹配
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>ArrayUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">contains</span><span style="color:#ff79c6">(</span>info<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mode</span><span style="color:#ff79c6">(),</span> mode<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;loading module instance failed: launch-mode is not match module required, will be ignored. module={};launch-mode={};required-mode={};class={};module-jar={};&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>                    uniqueId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>                    mode<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>                    StringUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">join</span><span style="color:#ff79c6">(</span>info<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mode</span><span style="color:#ff79c6">(),</span> <span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>                    classOfModule<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>                    moduleJarFile
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>            <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>            <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> mCb<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>                mCb<span style="color:#ff79c6">.</span><span style="color:#50fa7b">onLoad</span><span style="color:#ff79c6">(</span>uniqueId<span style="color:#ff79c6">,</span> classOfModule<span style="color:#ff79c6">,</span> module<span style="color:#ff79c6">,</span> moduleJarFile<span style="color:#ff79c6">,</span> moduleClassLoader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>        <span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="infomation">@Infomation<a class="anchorjs-link" href="#infomation"></a></h3><p>注解@Infomation 是沙箱内部定义的，主要是用来描述模块的信息。在上面 loadingModules 方法中使用 SPI 加载完对应的模块实现类，会查找对应的@Infomation 信息做一些前置检查操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>@Information<span style="color:#ff79c6">(</span>id <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;broken-clock-tinker&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">BrokenClockTinkerModule</span> <span style="color:#8be9fd;font-style:italic">implements</span> Module 
</span></span></code></pre></div><h3 id="onload真正的加载">onLoad(真正的加载)<a class="anchorjs-link" href="#onload%e7%9c%9f%e6%ad%a3%e7%9a%84%e5%8a%a0%e8%bd%bd"></a></h3><p>在上面的 loadingModules 方法中根据 SPI 机制已经获取到模块的实现类了，在 loadingModules 最后会调用 ModuleLoadCallback 的 onLoad 方法，onLoad 调用 DefaultCoreModuleManager#load 方法在这里则是真正加载模块实现类里面的内容。</p>
<p>加载的过程主要分为如下几步:</p>
<ol>
<li>
<p>初始化模块信息 CoreModule 在 coreModule 中有 module 的实现类，moduleJar,ModuleClassLoader,以及最重要的模块类转换器集合 sandboxClassFileTransformers，类转换器则是字节码增强的关键，代码增强章节会详细介绍</p>
</li>
<li>
<p>注入注解<a href="https://my.oschina.net/u/929718" target="_blank">@Resource</a> 资源，例如 ModuleEventWatcher 事件观察者。关于 ModuleEventWatcher 代码增强章节会详细介绍</p>
</li>
<li>
<p>通知生命周期中模块加载的对应实现（module 实现类可以同时实现 Module 接口以及沙箱模块生命周期接口 ModuleLifecyle 接口），在 ModuleLifecyle 接口对应的方法中，用户可以自定义实现业务逻辑。</p>
</li>
<li>
<p>激活模块并通知生命周期中模块激活的对应实现，只有被激活的模块才能响应模块的增强事件。</p>
</li>
<li>
<p>将模块唯一 id 和当前的 coreModule 实例存入模块列表，模块列表是一个全局的 ConcurrentHashMap。还记得在 Httpserver 启动时会初始化 ModuleHttpServlet,在 ModuleHttpServlet 接收请求时会从参数中解析出模块 id,从而获取到对应的 coreModule.</p>
</li>
<li>
<p>通知生命周期中模块加载完成的对应实现</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">load</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String uniqueId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>                               <span style="color:#8be9fd;font-style:italic">final</span> Module module<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                               <span style="color:#8be9fd;font-style:italic">final</span> File moduleJarFile<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                               <span style="color:#8be9fd;font-style:italic">final</span> ModuleJarClassLoader moduleClassLoader<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ModuleException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#6272a4">// 初始化模块信息
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> CoreModule coreModule <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CoreModule<span style="color:#ff79c6">(</span>uniqueId<span style="color:#ff79c6">,</span> moduleJarFile<span style="color:#ff79c6">,</span> moduleClassLoader<span style="color:#ff79c6">,</span> module<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#6272a4">// 注入@Resource 资源
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#6272a4"></span>    injectResourceOnLoadIfNecessary<span style="color:#ff79c6">(</span>coreModule<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#6272a4">// 通知生命周期，模块加载
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#6272a4"></span>    callAndFireModuleLifeCycle<span style="color:#ff79c6">(</span>coreModule<span style="color:#ff79c6">,</span> MODULE_LOAD<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#6272a4">// 设置为已经加载
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#6272a4"></span>    coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">markLoaded</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#6272a4">// 如果模块标记了加载时自动激活，则需要在加载完成之后激活模块
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#6272a4"></span>    markActiveOnLoadIfNecessary<span style="color:#ff79c6">(</span>coreModule<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#6272a4">// 注册到模块列表中
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#6272a4"></span>    loadedModuleBOMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>uniqueId<span style="color:#ff79c6">,</span> coreModule<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    <span style="color:#6272a4">// 通知生命周期，模块加载完成
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#6272a4"></span>    callAndFireModuleLifeCycle<span style="color:#ff79c6">(</span>coreModule<span style="color:#ff79c6">,</span> MODULE_LOAD_COMPLETED<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="小结-1">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93-1"></a></h3><p>在模块加载过程中，首先会通过遍历存储 module 的路径，然后通过自定义的模块 ClassLoader(ModuleJarClassLoader)以 SPI 的方式加载模块 jar 文件中的 Module 接口实现类，加载成功后会对模块进行前置检查，检查通过后则会对实现类注入 Resouce 资源并通知对应的生命周期事件，最后将 CoreModule 注册到模块列表中。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/39/397115193d765cc5dd61140451669f95.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="模块激活">模块激活<a class="anchorjs-link" href="#%e6%a8%a1%e5%9d%97%e6%bf%80%e6%b4%bb"></a></h2><p>模块在激活后就可以接收用户的自定义指令了，自定义指令其实就是通过@Command 注解在模块中自定义的 http 接口。在 http 接口对应的实现方法中可以做任何事情，例如触发代码增强。</p>
<p>在 <a href="http://sandbox.sh" target="_blank">sandbox.sh</a> 的启动脚本中可以看到通过使用-a 参数激活指定模块，本质将会发送请求调用&quot;sandbox-module-mgr/active&quot;,sandbox-module-mgr 是通用的沙箱系统管理模块</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># <span style="color:#ff79c6">-</span>a active module
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#ff79c6">[[</span> <span style="color:#ff79c6">-</span>n $<span style="color:#ff79c6">{</span>OP_MODULE_ACTIVE<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">]]</span> <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  sandbox_curl_with_exit <span style="color:#f1fa8c">&#34;sandbox-module-mgr/active&#34;</span> <span style="color:#f1fa8c">&#34;&amp;ids=${ARG_MODULE_ACTIVE}&#34;</span>
</span></span></code></pre></div><p>在 sandbox-mgr-module 项目的 ModuleMgrModule 类中，找到 active 方法的定义，因为 sandbox-mgr-module 属于系统模块，在上面介绍的模块加载中也会将系统模块进行加载，所以当使用-a 参数激活模块时也会通过 ModuleHttpServlet 将请求分发到 ModuleMgrModule 的 active 方法中进行处理。</p>
<p>在 active 中会解析参数，获取到要激活的模块 id，通过模块 id 找到对应的 module 实例（还记得在模块加载章节中介绍的当模块加载完成后会将模块的 coreModule 存储到 loadedModuleBOMap 中吧，这里的 search 本质就是从 map 中查找对应的 coreModule）</p>
<p>获取 module 实现类中的@Information 注解 id，判断是否已经激活，如果没激活则进行激活</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Command<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;active&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">active</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> Map<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> param<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                   <span style="color:#8be9fd;font-style:italic">final</span> PrintWriter writer<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ModuleException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#8be9fd">int</span> total <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> String idsStringPattern <span style="color:#ff79c6">=</span> getParamWithDefault<span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;ids&#34;</span><span style="color:#ff79c6">,</span> EMPTY<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> Module module <span style="color:#ff79c6">:</span> search<span style="color:#ff79c6">(</span>idsStringPattern<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> Information info <span style="color:#ff79c6">=</span> module<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getAnnotation</span><span style="color:#ff79c6">(</span>Information<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> isActivated <span style="color:#ff79c6">=</span> moduleManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isActivated</span><span style="color:#ff79c6">(</span>info<span style="color:#ff79c6">.</span><span style="color:#50fa7b">id</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>isActivated<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                moduleManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">active</span><span style="color:#ff79c6">(</span>info<span style="color:#ff79c6">.</span><span style="color:#50fa7b">id</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                total<span style="color:#ff79c6">++;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>ModuleException me<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;active module[id={};] occur error={}.&#34;</span><span style="color:#ff79c6">,</span> me<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUniqueId</span><span style="color:#ff79c6">(),</span> me<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getErrorCode</span><span style="color:#ff79c6">(),</span> me<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>            <span style="color:#ff79c6">}</span><span style="color:#6272a4">// try
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>            total<span style="color:#ff79c6">++;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    <span style="color:#ff79c6">}</span><span style="color:#6272a4">// for
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#6272a4"></span>    output<span style="color:#ff79c6">(</span>writer<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;total %s module activated.&#34;</span><span style="color:#ff79c6">,</span> total<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="小结-2">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93-2"></a></h3><p>激活的本质就是将 coreModule 实例的 isActivated 标记设置为 true,这样模块才可以接收到代码增强触发的事件</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/42/42ff71f24d83b8b89238551331178e10.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="模块冻结">模块冻结<a class="anchorjs-link" href="#%e6%a8%a1%e5%9d%97%e5%86%bb%e7%bb%93"></a></h2><p>模块冻结是将已加载的模块的打上冻结标记，冻结后用户自定义的增强代码还存在，只不过沙箱不会处理用户自定义的代码增强逻辑。</p>
<p>在启动脚本中,冻结指令也是发往 sandbox-module-mgr 沙箱系统管理模块</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># <span style="color:#ff79c6">-</span>A frozen module
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#ff79c6">[[</span> <span style="color:#ff79c6">-</span>n $<span style="color:#ff79c6">{</span>OP_MODULE_FROZEN<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">]]</span> <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  sandbox_curl_with_exit <span style="color:#f1fa8c">&#34;sandbox-module-mgr/frozen&#34;</span> &#34;<span style="color:#ff79c6">&amp;</span>ids<span style="color:#ff79c6">=</span>$<span style="color:#ff79c6">{</span>ARG_MODULE_FROZEN<span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="小结-3">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93-3"></a></h3><p>模块冻结的处理过程和模块激活的处理过程基本相同，但是多了一步冻结事件处理器。</p>
<p>事件处理器在代码增强和事件处理章节中将会介绍。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/76/7667e7e19aff4dd48643bcdfc5212c79.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="模块卸载">模块卸载<a class="anchorjs-link" href="#%e6%a8%a1%e5%9d%97%e5%8d%b8%e8%bd%bd"></a></h2><p>模块卸载将会把模块整个从沙箱中清理掉，之前给该模块分配的所有资源都将会被回收，包括模块已经侦听事件的类都将会被移除掉侦听插桩，干净利落不留后遗症</p>
<p>在启动脚本中,冻结指令也是发往 sandbox-module-mgr 沙箱系统管理模块</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># <span style="color:#ff79c6">-</span>u unload module
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#ff79c6">[[</span> <span style="color:#ff79c6">-</span>n $<span style="color:#ff79c6">{</span>OP_MODULE_UNLOAD<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">]]</span> <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  sandbox_curl_with_exit <span style="color:#f1fa8c">&#34;sandbox-module-mgr/unload&#34;</span> <span style="color:#f1fa8c">&#34;&amp;action=unload&amp;ids=${ARG_MODULE_UNLOAD}&#34;</span>
</span></span></code></pre></div><p>模块卸载的流程</p>
<ol>
<li>
<p>尝试冻结模块，让事件处理器暂停不在执行用户自定义的增强逻辑。</p>
</li>
<li>
<p>通知生命周期模块卸载的对应实现</p>
</li>
<li>
<p>从模块注册表中删除对应的模块</p>
</li>
<li>
<p>标记卸载，isLoaded=true</p>
</li>
<li>
<p>释放资源，在模块加载流程中有一步是注入@Resource 资源，在注入 ModuleEventWatcher 资源时，实际上是构建了 ReleaseResource 对象，并实现了 release 方法。在 ModuleEventWatcher.delete 中会利用 Instrumentation 类库删除类增强转换器 SandboxClassFileTransformer，这样有新的类加载时将不会植入 spy 间谍类了。但是已加载的类总还是有间谍类的代码。通过 Instrumentation 类库重新渲染目标类字节码。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">delete</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> watcherId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                   <span style="color:#8be9fd;font-style:italic">final</span> Progress progress<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> Set<span style="color:#ff79c6">&lt;</span>Matcher<span style="color:#ff79c6">&gt;</span> waitingRemoveMatcherSet <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LinkedHashSet<span style="color:#ff79c6">&lt;</span>Matcher<span style="color:#ff79c6">&gt;();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#6272a4">// 找出待删除的 SandboxClassFileTransformer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> Iterator<span style="color:#ff79c6">&lt;</span>SandboxClassFileTransformer<span style="color:#ff79c6">&gt;</span> cftIt <span style="color:#ff79c6">=</span> coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSandboxClassFileTransformers</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">iterator</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#8be9fd">int</span> cCnt <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">,</span> mCnt <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>cftIt<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> SandboxClassFileTransformer sandboxClassFileTransformer <span style="color:#ff79c6">=</span> cftIt<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>watcherId <span style="color:#ff79c6">==</span> sandboxClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getWatchId</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            <span style="color:#6272a4">// 冻结所有关联代码增强
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#6272a4"></span>            EventListenerHandler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSingleton</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">frozen</span><span style="color:#ff79c6">(</span>sandboxClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getListenerId</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>            <span style="color:#6272a4">// 在 JVM 中移除掉命中的 ClassFileTransformer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#6272a4"></span>            inst<span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeTransformer</span><span style="color:#ff79c6">(</span>sandboxClassFileTransformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>            <span style="color:#6272a4">// 计数
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#6272a4"></span>            cCnt <span style="color:#ff79c6">+=</span> sandboxClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAffectStatistic</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">cCnt</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            mCnt <span style="color:#ff79c6">+=</span> sandboxClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAffectStatistic</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">mCnt</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>            <span style="color:#6272a4">// 追加到待删除过滤器集合
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#6272a4"></span>            waitingRemoveMatcherSet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>sandboxClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMatcher</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>            <span style="color:#6272a4">// 清除掉该 SandboxClassFileTransformer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#6272a4"></span>            cftIt<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>    <span style="color:#6272a4">// 查找需要删除后重新渲染的类集合
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> List<span style="color:#ff79c6">&lt;</span>Class<span style="color:#ff79c6">&lt;?&gt;&gt;</span> waitingReTransformClasses <span style="color:#ff79c6">=</span> classDataSource<span style="color:#ff79c6">.</span><span style="color:#50fa7b">findForReTransform</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>            <span style="color:#ff79c6">new</span> GroupMatcher<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Or</span><span style="color:#ff79c6">(</span>waitingRemoveMatcherSet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Matcher<span style="color:#ff79c6">[</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">]))</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;watch={} in module={} found {} classes for delete.&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>            watcherId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>            coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUniqueId</span><span style="color:#ff79c6">(),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>            waitingReTransformClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>    beginProgress<span style="color:#ff79c6">(</span>progress<span style="color:#ff79c6">,</span> waitingReTransformClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>        <span style="color:#6272a4">// 应用 JVM
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span><span style="color:#6272a4"></span>        reTransformClasses<span style="color:#ff79c6">(</span>watcherId<span style="color:#ff79c6">,</span> waitingReTransformClasses<span style="color:#ff79c6">,</span> progress<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>        finishProgress<span style="color:#ff79c6">(</span>progress<span style="color:#ff79c6">,</span> cCnt<span style="color:#ff79c6">,</span> mCnt<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><ol start="6">
<li>关闭 ModuleJarClassLoader，可以将其加载的模块类全部从 jvm 清理掉。在关闭前会利用 SPI 找到模块中 ModuleJarUnloadSPI 接口的实现类，通知模块已经被卸载了可以做一些自定义的业务处理。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">closeIfPossible</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    onJarUnLoadCompleted<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#6272a4">// 如果是 JDK7+的版本, URLClassLoader 实现了 Closeable 接口，直接调用即可
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span> <span style="color:#ff79c6">instanceof</span> Closeable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;JDK is 1.7+, use URLClassLoader[file={}].close()&#34;</span><span style="color:#ff79c6">,</span> moduleJarFile<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                <span style="color:#ff79c6">((</span>Closeable<span style="color:#ff79c6">)</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;close ModuleJarClassLoader[file={}] failed. JDK7+&#34;</span><span style="color:#ff79c6">,</span> moduleJarFile<span style="color:#ff79c6">,</span> cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#ff79c6">.......</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span> <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="小结-4">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93-4"></a></h3><p>模块卸载中首先会暂停事件的处理，然后利用 Instrumentation 卸载增强的字节码以及恢复原始字节码，最后关闭 ModuleClassLoader</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/32/3279da313884c5cfce686fea8fcdb88e.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h1 id="代码增强">代码增强<a class="anchorjs-link" href="#%e4%bb%a3%e7%a0%81%e5%a2%9e%e5%bc%ba"></a></h1><p>本章节将重点介绍如何利用 sandbox 对代码进行增强以及背后的实现原理</p>
<h2 id="自定义模块">自定义模块<a class="anchorjs-link" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%a8%a1%e5%9d%97"></a></h2><p>参考官方 demo 对代码增强前我们首先自定义模块 如下所示：</p>
<p>在自定义模块中需要实现 Module 接口，声明@Information 注解指定唯一 id，定义 ModuleEventWatcher 注解，声明自定义@Command 指令的处理方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Information<span style="color:#ff79c6">(</span>id <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;broken-clock-tinker&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">BrokenClockTinkerModule</span> <span style="color:#8be9fd;font-style:italic">implements</span> Module <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    @Resource
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">private</span> ModuleEventWatcher moduleEventWatcher<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    @Command<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;repairCheckState&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">repairCheckState</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#ff79c6">new</span> EventWatchBuilder<span style="color:#ff79c6">(</span>moduleEventWatcher<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">onClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;com.taobao.demo.Clock&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">onBehavior</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;checkState&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">onWatch</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> AdviceListener<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#6272a4">                     * 拦截{@code com.taobao.demo.Clock#checkState()}方法，当这个方法抛出异常时将会被
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#6272a4">                     * AdviceListener#afterThrowing()所拦截
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style="color:#6272a4">                     */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>                    @Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">afterThrowing</span><span style="color:#ff79c6">(</span>Advice advice<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Throwable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                        <span style="color:#6272a4">// 在此，你可以通过 ProcessController 来改变原有方法的执行流程
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 这里的代码意义是：改变原方法抛出异常的行为，变更为立即返回；void 返回值用 null 表示
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#6272a4"></span>                        ProcessController<span style="color:#ff79c6">.</span><span style="color:#50fa7b">returnImmediately</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>                <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>demo 中会利用 EventWatchBuilder 对 Clock 类中的 checkState 方法进行代码增强，当 checkState 方法抛出异常后会执行 afterThrowing 方法中的代码，将异常忽略掉直接返回。</p>
<h2 id="watch">watch<a class="anchorjs-link" href="#watch"></a></h2><p>重点关注下 onWatch 方法，在经过层层调用会到达 DefaultModuleEventWatch 的 watch 方法，而 watch 方法则是真正触发代码增强的入口。</p>
<ol>
<li>
<p>在 watch 方法中首先会创建 SandboxClassFileTransformer 沙箱类转换器，并将其注册到 CoreModule 中</p>
</li>
<li>
<p>利用 Instrumentation 类库的 addTransformer api 注册 SandboxClassFileTransformer 沙箱类转换器实例注册类转换器后，后面所有的类加载都会经过 SandboxClassFileTransformer</p>
</li>
<li>
<p>查找需要渲染的类集合，利用 matcher 对象查找当前 jvm 已加载的类matcher 对象则是 EventWatchBuilder 中指定的目标类和目标方法的包装对象，在 matcher 对象中指定了匹配规则。</p>
</li>
<li>
<p>将查找到的类进行渲染（代码增强），利用 Instrumentation 的 retransformClasses 方法重新对 JVM 已加载的类进行字节码转换。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">watch</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> Matcher matcher<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>                  <span style="color:#8be9fd;font-style:italic">final</span> EventListener listener<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                  <span style="color:#8be9fd;font-style:italic">final</span> Progress progress<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                  <span style="color:#8be9fd;font-style:italic">final</span> Event<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Type</span><span style="color:#ff79c6">...</span> eventType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> watchId <span style="color:#ff79c6">=</span> watchIdSequencer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#6272a4">// 给对应的模块追加 ClassFileTransformer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> SandboxClassFileTransformer sandClassFileTransformer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> SandboxClassFileTransformer<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            watchId<span style="color:#ff79c6">,</span> coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUniqueId</span><span style="color:#ff79c6">(),</span> matcher<span style="color:#ff79c6">,</span> listener<span style="color:#ff79c6">,</span> isEnableUnsafe<span style="color:#ff79c6">,</span> eventType<span style="color:#ff79c6">,</span> namespace<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#6272a4">// 注册到 CoreModule 中
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#6272a4"></span>    coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSandboxClassFileTransformers</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>sandClassFileTransformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#6272a4">//这里 addTransformer 后，接下来引起的类加载都会经过 sandClassFileTransformer
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#6272a4"></span>    inst<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addTransformer</span><span style="color:#ff79c6">(</span>sandClassFileTransformer<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#6272a4">// 查找需要渲染的类集合
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> List<span style="color:#ff79c6">&lt;</span>Class<span style="color:#ff79c6">&lt;?&gt;&gt;</span> waitingReTransformClasses <span style="color:#ff79c6">=</span> classDataSource<span style="color:#ff79c6">.</span><span style="color:#50fa7b">findForReTransform</span><span style="color:#ff79c6">(</span>matcher<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;watch={} in module={} found {} classes for watch(ing).&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>            watchId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>            coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUniqueId</span><span style="color:#ff79c6">(),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>            waitingReTransformClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    <span style="color:#8be9fd">int</span> cCnt <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">,</span> mCnt <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#6272a4">// 进度通知启动
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span><span style="color:#6272a4"></span>    beginProgress<span style="color:#ff79c6">(</span>progress<span style="color:#ff79c6">,</span> waitingReTransformClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>        <span style="color:#6272a4">// 应用 JVM
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span><span style="color:#6272a4"></span>        reTransformClasses<span style="color:#ff79c6">(</span>watchId<span style="color:#ff79c6">,</span>waitingReTransformClasses<span style="color:#ff79c6">,</span> progress<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>        <span style="color:#6272a4">// 计数
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span><span style="color:#6272a4"></span>        cCnt <span style="color:#ff79c6">+=</span> sandClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAffectStatistic</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">cCnt</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        mCnt <span style="color:#ff79c6">+=</span> sandClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAffectStatistic</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">mCnt</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>        <span style="color:#6272a4">// 激活增强类
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>coreModule<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isActivated</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>            <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> listenerId <span style="color:#ff79c6">=</span> sandClassFileTransformer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getListenerId</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>            EventListenerHandler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSingleton</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">active</span><span style="color:#ff79c6">(</span>listenerId<span style="color:#ff79c6">,</span> listener<span style="color:#ff79c6">,</span> eventType<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>        finishProgress<span style="color:#ff79c6">(</span>progress<span style="color:#ff79c6">,</span> cCnt<span style="color:#ff79c6">,</span> mCnt<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>    <span style="color:#ff79c6">return</span> watchId<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><h2 id="字节码转换">字节码转换<a class="anchorjs-link" href="#%e5%ad%97%e8%8a%82%e7%a0%81%e8%bd%ac%e6%8d%a2"></a></h2><p>在基础知识章节中介绍了对字节码转换主要是需要实现 ClassFileTransformer 接口，然后将实现类注册到 Instrumentation 中即可在合适的时机触发字节码转换，也可以通过 Instrumentation 的 api 例如 retransformClasses 手动触发。</p>
<p>在 SandboxClassFileTransformer#_transform 方法中主要就是当类加载或者重新定义时匹配是不是我们要增强的目标类和目标方法，如果是的话则利用沙箱的代码增强框架进行字节码生成，如果不是则忽略不处理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">_transform</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> ClassLoader loader<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>                          <span style="color:#8be9fd;font-style:italic">final</span> String internalClassName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                          <span style="color:#8be9fd;font-style:italic">final</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> classBeingRedefined<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                          <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> srcByteCodeArray<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#6272a4">// 如果未开启 unsafe 开关，是不允许增强来自 BootStrapClassLoader 的类
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>isEnableUnsafe
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> loader<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transform ignore {}, class from bootstrap but unsafe.enable=false.&#34;</span><span style="color:#ff79c6">,</span> internalClassName<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> ClassStructure classStructure <span style="color:#ff79c6">=</span> getClassStructure<span style="color:#ff79c6">(</span>loader<span style="color:#ff79c6">,</span> classBeingRedefined<span style="color:#ff79c6">,</span> srcByteCodeArray<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> MatchingResult matchingResult <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> UnsupportedMatcher<span style="color:#ff79c6">(</span>loader<span style="color:#ff79c6">,</span> isEnableUnsafe<span style="color:#ff79c6">).</span><span style="color:#50fa7b">and</span><span style="color:#ff79c6">(</span>matcher<span style="color:#ff79c6">).</span><span style="color:#50fa7b">matching</span><span style="color:#ff79c6">(</span>classStructure<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> behaviorSignCodes <span style="color:#ff79c6">=</span> matchingResult<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBehaviorSignCodes</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#6272a4">// 如果一个行为都没匹配上也不用继续了
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>matchingResult<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isMatched</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transform ignore {}, no behaviors matched in loader={}&#34;</span><span style="color:#ff79c6">,</span> internalClassName<span style="color:#ff79c6">,</span> loader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    <span style="color:#6272a4">// 开始进行类匹配
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> toByteCodeArray <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> EventEnhancer<span style="color:#ff79c6">().</span><span style="color:#50fa7b">toByteCodeArray</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>                loader<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>                srcByteCodeArray<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>                behaviorSignCodes<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>                namespace<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>                listenerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>                eventTypeArray
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>        <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>srcByteCodeArray <span style="color:#ff79c6">==</span> toByteCodeArray<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>            logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transform ignore {}, nothing changed in loader={}&#34;</span><span style="color:#ff79c6">,</span> internalClassName<span style="color:#ff79c6">,</span> loader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>        <span style="color:#6272a4">// statistic affect
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span><span style="color:#6272a4"></span>        affectStatistic<span style="color:#ff79c6">.</span><span style="color:#50fa7b">statisticAffect</span><span style="color:#ff79c6">(</span>loader<span style="color:#ff79c6">,</span> internalClassName<span style="color:#ff79c6">,</span> behaviorSignCodes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transform {} finished, by module={} in loader={}&#34;</span><span style="color:#ff79c6">,</span> internalClassName<span style="color:#ff79c6">,</span> uniqueId<span style="color:#ff79c6">,</span> loader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>        <span style="color:#ff79c6">return</span> toByteCodeArray<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transform {} failed, by module={} in loader={}&#34;</span><span style="color:#ff79c6">,</span> internalClassName<span style="color:#ff79c6">,</span> uniqueId<span style="color:#ff79c6">,</span> loader<span style="color:#ff79c6">,</span> cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>在 EventEnhancer#toByteCodeArray 方法中利用 ASM 框架对代码进行增强，通过 ASM 的 ClassReader 读取目标类字节码，然后通过 ClassWriter 将转换后的字节码写入 dump 文件夹，并将转换后的字节码返回。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">toByteCodeArray</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> ClassLoader targetClassLoader<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                              <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> byteCodeArray<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                              <span style="color:#8be9fd;font-style:italic">final</span> Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> signCodes<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                              <span style="color:#8be9fd;font-style:italic">final</span> String namespace<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                              <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> listenerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                              <span style="color:#8be9fd;font-style:italic">final</span> Event<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Type</span><span style="color:#ff79c6">[]</span> eventTypeArray<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#6272a4">// 返回增强后字节码
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> ClassReader cr <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ClassReader<span style="color:#ff79c6">(</span>byteCodeArray<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> ClassWriter cw <span style="color:#ff79c6">=</span> createClassWriter<span style="color:#ff79c6">(</span>targetClassLoader<span style="color:#ff79c6">,</span> cr<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> targetClassLoaderObjectID <span style="color:#ff79c6">=</span> ObjectIDs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">instance</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">identity</span><span style="color:#ff79c6">(</span>targetClassLoader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    cr<span style="color:#ff79c6">.</span><span style="color:#50fa7b">accept</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            <span style="color:#ff79c6">new</span> EventWeaver<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>                    ASM7<span style="color:#ff79c6">,</span> cw<span style="color:#ff79c6">,</span> namespace<span style="color:#ff79c6">,</span> listenerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>                    targetClassLoaderObjectID<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>                    cr<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassName</span><span style="color:#ff79c6">(),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>                    signCodes<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>                    eventTypeArray
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>            <span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>            EXPAND_FRAMES
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    <span style="color:#ff79c6">return</span> dumpClassIfNecessary<span style="color:#ff79c6">(</span>cr<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassName</span><span style="color:#ff79c6">(),</span> cw<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>转换过程则是通过继承 ClassVisitor 抽象类实现方法事件织入者 EventWeaver，在 EventWeaver 中会对目标方法进行匹配，如果匹配成功则织入 Spy 间谍类中的埋点方法。具体代码在 EventWeaver#visitMethod 方法中，内容太长就不粘贴了。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/9f/9f01ac6285e77f8d188bd435d440f1f4.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="小结-5">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93-5"></a></h2><p>在代码增强流程中利用 Instrumentation 类库的 addTransformer api 注册 SandboxClassFileTransformer 沙箱类转换器实例，当类加载、类重新定义、类转换的时候会触发 SandboxClassFileTransformer 的 transformer 方法进行字节码转换，本质是使用 ASM 框架在对目标方法和类进行转换时将 SPY 间谍类中的方法织入到目标方法中，最后输出增强后的字节码 byte[]</p>
<h1 id="事件处理">事件处理<a class="anchorjs-link" href="#%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86"></a></h1><p>在代码增强章节中介绍了是如何将间谍类织入到目标方法中的生成的字节码会生成类重新应用到 jvm 中，那么增强后的方法是如何执行到用户自定义的增强逻辑中呢？</p>
<p>拿 spyMethodOnBefore 举例，假如我们对目标方法监听的是 Before 事件，因为增强后的代码在目标方法执行前会执行 spyMethodOnBefore 方法，在 spyMethodOnBefore 中会找到模块对应的 SpyHandler 间谍处理器实例 EventListenHandler。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Ret <span style="color:#50fa7b">spyMethodOnBefore</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> Object<span style="color:#ff79c6">[]</span> argumentArray<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> String namespace<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> listenerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> targetClassLoaderObjectID<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> String javaClassName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> String javaMethodName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> String javaMethodDesc<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                                    <span style="color:#8be9fd;font-style:italic">final</span> Object target<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Throwable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> Thread thread <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>selfCallBarrier<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isEnter</span><span style="color:#ff79c6">(</span>thread<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        <span style="color:#ff79c6">return</span> Ret<span style="color:#ff79c6">.</span><span style="color:#50fa7b">RET_NONE</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> SelfCallBarrier<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Node</span> node <span style="color:#ff79c6">=</span> selfCallBarrier<span style="color:#ff79c6">.</span><span style="color:#50fa7b">enter</span><span style="color:#ff79c6">(</span>thread<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        <span style="color:#8be9fd;font-style:italic">final</span> SpyHandler spyHandler <span style="color:#ff79c6">=</span> namespaceSpyHandlerMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>namespace<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> spyHandler<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>            <span style="color:#ff79c6">return</span> Ret<span style="color:#ff79c6">.</span><span style="color:#50fa7b">RET_NONE</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        <span style="color:#ff79c6">return</span> spyHandler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handleOnBefore</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>                listenerId<span style="color:#ff79c6">,</span> targetClassLoaderObjectID<span style="color:#ff79c6">,</span> argumentArray<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>                javaClassName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>                javaMethodName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>                javaMethodDesc<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>                target
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>        <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>        handleException<span style="color:#ff79c6">(</span>cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>        <span style="color:#ff79c6">return</span> Ret<span style="color:#ff79c6">.</span><span style="color:#50fa7b">RET_NONE</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>        selfCallBarrier<span style="color:#ff79c6">.</span><span style="color:#50fa7b">exit</span><span style="color:#ff79c6">(</span>thread<span style="color:#ff79c6">,</span> node<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="eventlistenhandler">EventListenHandler<a class="anchorjs-link" href="#eventlistenhandler"></a></h2><p>EventListenHandler 是 SpyHandler 接口的实现类，在 handleOnBefore 中将会通过 listenerID 找到事件处理器 processor,在事件处理器中有用户自定义的 listenr 实例，这样就可以回调 listener 的 OnEvent 方法，执行真正用户在自定义模块中编写的代码了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>@Override
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">public</span> Spy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Ret</span> <span style="color:#50fa7b">handleOnBefore</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> listenerId<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> targetClassLoaderObjectID<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">[]</span> argumentArray<span style="color:#ff79c6">,</span> String javaClassName<span style="color:#ff79c6">,</span> String javaMethodName<span style="color:#ff79c6">,</span> String javaMethodDesc<span style="color:#ff79c6">,</span> Object target<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Throwable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#6272a4">// 在守护区内产生的事件不需要响应
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>SandboxProtector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">instance</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isInProtecting</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;listener={} is in protecting, ignore processing before-event&#34;</span><span style="color:#ff79c6">,</span> listenerId<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        <span style="color:#ff79c6">return</span> newInstanceForNone<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#6272a4">// 获取事件处理器
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> EventProcessor processor <span style="color:#ff79c6">=</span> mappingOfEventProcessor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>listenerId<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#6272a4">// 如果尚未注册,则直接返回,不做任何处理
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> processor<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;listener={} is not activated, ignore processing before-event.&#34;</span><span style="color:#ff79c6">,</span> listenerId<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        <span style="color:#ff79c6">return</span> newInstanceForNone<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    <span style="color:#6272a4">// 获取调用跟踪信息
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> EventProcessor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Process</span> process <span style="color:#ff79c6">=</span> processor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">processRef</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    <span style="color:#6272a4">// 如果当前处理 ID 被忽略，则立即返回
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>process<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isIgnoreProcess</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;listener={} is marked ignore process!&#34;</span><span style="color:#ff79c6">,</span> listenerId<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>        <span style="color:#ff79c6">return</span> newInstanceForNone<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>    <span style="color:#6272a4">// 调用 ID
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> invokeId <span style="color:#ff79c6">=</span> invokeIdSequencer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAndIncrement</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>    process<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pushInvokeId</span><span style="color:#ff79c6">(</span>invokeId<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>    <span style="color:#6272a4">// 调用过程 ID
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> processId <span style="color:#ff79c6">=</span> process<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProcessId</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> ClassLoader javaClassLoader <span style="color:#ff79c6">=</span> ObjectIDs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">instance</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">(</span>targetClassLoaderObjectID<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>    <span style="color:#6272a4">//放置业务类加载器
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span><span style="color:#6272a4"></span>    BusinessClassLoaderHolder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setBussinessClassLoader</span><span style="color:#ff79c6">(</span>javaClassLoader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>    <span style="color:#8be9fd;font-style:italic">final</span> BeforeEvent event <span style="color:#ff79c6">=</span> process<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEventFactory</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">makeBeforeEvent</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>            processId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>            invokeId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>            javaClassLoader<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>            javaClassName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>            javaMethodName<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>            javaMethodDesc<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>            target<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>            argumentArray
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>        <span style="color:#ff79c6">return</span> handleEvent<span style="color:#ff79c6">(</span>listenerId<span style="color:#ff79c6">,</span> processId<span style="color:#ff79c6">,</span> invokeId<span style="color:#ff79c6">,</span> event<span style="color:#ff79c6">,</span> processor<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>        process<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEventFactory</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">returnEvent</span><span style="color:#ff79c6">(</span>event<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="eventprocessor">EventProcessor<a class="anchorjs-link" href="#eventprocessor"></a></h2><p>EventProcessor 事件处理器中包含了用户自定义的 listener 以及 listenerId，在执行增强代码时会记录调用的堆栈。</p>
<p>在代码增强 watch 章节中，watch 方法执行的最后会激活增强类，在这里就是主要是将 listenerId 当作 key,将 EventProcessor 当作 value 存入到 map 中。这样当接收到事件时则可以根据 listenerId 查找到对应的事件处理器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">active</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> listenerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>                   <span style="color:#8be9fd;font-style:italic">final</span> EventListener listener<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>                   <span style="color:#8be9fd;font-style:italic">final</span> Event<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Type</span><span style="color:#ff79c6">[]</span> eventTypes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    mappingOfEventProcessor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>listenerId<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> EventProcessor<span style="color:#ff79c6">(</span>listenerId<span style="color:#ff79c6">,</span> listener<span style="color:#ff79c6">,</span> eventTypes<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;activated listener[id={};target={};] event={}&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>            listenerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>            listener<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>            join<span style="color:#ff79c6">(</span>eventTypes<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="listenerid">listenerId<a class="anchorjs-link" href="#listenerid"></a></h2><p>listenerId 可以理解为自定义模块每对一个目标方法进行 watch 都会生成一个全局唯一的 id，通过这个 id 来绑定对应的事件处理器</p>
<h2 id="listener">listener<a class="anchorjs-link" href="#listener"></a></h2><p>事件处理器最终的目的就是回调 listener 中的方法，listener 是我们在自定义模块中对目标方法进行 watch 时所传递的参数，在 listener 的 onEvent 或者 AdviceListener 的各个埋点方法中可以任意实现要对目标方法增强的逻辑。</p>
<h2 id="小结-6">小结<a class="anchorjs-link" href="#%e5%b0%8f%e7%bb%93-6"></a></h2><p>在事件处理流程中通过 SpyHandler 的实现类 EventListenHandler 进行事件的分发，匹配到当前事件对应的事件处理器 EventProcessor，在 EventProcessor 中会真正的回调用户实现的 listener,从而完成真正的用户自定义代码增强逻辑。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="https://static001.geekbang.org/infoq/f8/f81c8e7021c45b73e102796edfeee235.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h1 id="总结">总结<a class="anchorjs-link" href="#%e6%80%bb%e7%bb%93"></a></h1><p>JVM-SANDBOX 是一种 JVM 的非侵入式运行期 AOP 解决方案，通过它我们可以很轻松的开发出很多有趣的项目如录制回放、故障模拟、动态日志、行链路获取等等，在本文中通过源码分析介绍了 JVM-SANDBOX 实现细节，了解到它的核心实现。</p>
<p>回顾下关键内容:</p>
<ol>
<li>
<p>JVM-SANDBOX 基于 JVM TI(JVM 工具接口)实现 agent 对目标 jvm 进行挂载，利用 Instrumentation 类库注册自定义的类转换器（SandboxClassFileTransformer），在类转换器中使用 ASM 框架对目标类的方法织入 Spy 间谍类中的埋点方法，从而实现字节码增强功能。</p>
</li>
<li>
<p>JVM-SANDBOX 利用 ClassLoader 双亲委派模型，自定义 SandboxClassLoader 加载沙箱内部类(spy-core)，使用自定义 ModulerJarClassLoader 和 SPI 机制对自定义模块进行加载，从而实现类隔离。</p>
</li>
<li>
<p>可插拔以及多租户的特性更多的是偏于 JVM-SANDBOX 内部的业务逻辑，在模块管理章节模块的加载和卸载中有详细描述。</p>
</li>
</ol>
<p>最后在解释下为什么要对 jvm-sandbox 进行源码分析，是因为在工作中以及开源社区中都有使用到 jvm-sandbox 也发现了一些 bug 例如多次模块加载和卸载会导致 metaspace oom等。后面有精力也会对 bug 以及解决过程进行分享。</p>
<h1 id="作者介绍">作者介绍<a class="anchorjs-link" href="#%e4%bd%9c%e8%80%85%e4%bb%8b%e7%bb%8d"></a></h1><p>Github 账号：<a href="https://github.com/binbin0325" target="_blank">binbin0325</a>，公众号:<a href="/about" target="_blank">柠檬汁Code</a>，<a href="https://github.com/alibaba/sentinel-golang" target="_blank">Sentinel-Golang</a> Committer 、<a href="https://github.com/chaosblade-io/chaosblade" target="_blank">ChaosBlade</a> Committer 、 <a href="https://github.com/alibaba/nacos" target="_blank">Nacos</a> PMC 、<a href="https://github.com/apache/dubbo-go" target="_blank">Apache Dubbo-Go</a> Committer。目前主要关注于混沌工程、中间件以及云原生方向。</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/wechat/info.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>


        <hr style="visibility: hidden;" />
        <ul class="pager">
          
          <li class="previous">
            <a href="/posts/chaosblade-mem/" data-toggle="tooltip" data-placement="top" title="强化服务韧性：ChaosBlade磁盘故障模拟的原理与应用">
              Previous<br>
              <span>强化服务韧性：ChaosBlade磁盘故障模拟的原理与应用</span>
            </a>
          </li>
          
          
          <li class="next">
            <a href="/posts/jvm-sandbox-1/" data-toggle="tooltip" data-placement="top" title="JVM-SANDBOX导致目标服务JVM Metaspace OOM的调查始末">
              Next<br>
              <span>JVM-SANDBOX导致目标服务JVM Metaspace OOM的调查始末</span>
            </a>
          </li>
          
        </ul>
        <hr style="visibility: hidden;" />

        
        



<div class="giscus" id="comments"></div>
<script src="https://giscus.app/client.js" 
  data-repo="roninro/hugo-theme-puppet" 
  data-repo-id="R_kgDOHuvyhw"
  data-category="General"
  data-category-id="DIC_kwDOHuvyh84CQjDo"
  data-mapping="pathname"
  data-strict="0" 
  data-reactions-enabled="1" 
  data-emit-metadata="0" 
  data-input-position="top"
  data-theme="light_tritanopia"
  data-lang="en"
  crossorigin="anonymous"
  async>
  </script>




      </div>

      
      
      
      <div class="
              col-lg-2 col-lg-offset-0
              visible-lg-block
              sidebar-container
              catalog-container">
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs">
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div>
      
      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              sidebar-container">

        
        
        <section>
  
  
  <hr class="hidden-sm hidden-xs">
  
  <h5>FEATURED TAGS</h5>
  <div class="tags">
    
    <a href="/tags/algorithm/">algorithm</a>
    
    <a href="/tags/cgroups/">cgroups</a>
    
    <a href="/tags/chaos/">chaos</a>
    
    <a href="/tags/chaosblade/">chaosblade</a>
    
    <a href="/tags/cpu/">cpu</a>
    
    <a href="/tags/java/">java</a>
    
    <a href="/tags/jvm/">jvm</a>
    
    <a href="/tags/linux/">linux</a>
    
    <a href="/tags/mem/">mem</a>
    
    <a href="/tags/namespace/">namespace</a>
    
    <a href="/tags/sentinel-go/">sentinel-go</a>
    
    <a href="/tags/%E5%90%8C%E5%9F%8E%E5%8F%8C%E6%B4%BB/">同城双活</a>
    
    <a href="/tags/%E5%AD%97%E8%8A%82%E7%A0%81/">字节码</a>
    
    <a href="/tags/%E5%AE%B9%E7%81%BE%E6%9E%B6%E6%9E%84/">容灾架构</a>
    
    <a href="/tags/%E5%BC%82%E5%9C%B0%E5%A4%9A%E6%B4%BB/">异地多活</a>
    
    <a href="/tags/%E6%B7%B7%E6%B2%8C%E5%B7%A5%E7%A8%8B/">混沌工程</a>
    
  </div>
</section>

        
        

<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="" target="_blank">WeChat:柠檬汁Code</a></li>
  
</ul>

      </div>
    </div>
  </div>
</article>



  
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        <ul class="list-inline text-center">

<li>
  <a href="https://github.com/binbin0325" target="_blank">
    <span class="fa-stack fa-lg">
      <i class="fa fa-circle fa-stack-2x"></i>
      <i class="fab fa-github fa-stack-1x fa-inverse"></i>
    </span>
  </a>
</li></ul>

        <p class="copyright text-muted">
          Copyright &copy; binbin0325 2023  
          <br>
          Powered by <a href="https://gohugo.io">Hugo</a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin="anonymous"></script>



<script src="/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js"></script>


<script src=/js/simple-jekyll-search.min.js></script>


<script src="/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js"></script>






<script type="text/javascript">
  function generateCatalog(selector) {
    _containerSelector = 'div.post-container'
    
    var P = $(_containerSelector), a, n, t, l, i, c;
    a = P.find('h1,h2,h3,h4');
    
    $(selector).html('')
    
    a.each(function () {
      n = $(this).prop('tagName').toLowerCase();
      i = "#" + $(this).prop('id');
      t = $(this).text();
      c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
      l = $('<li class="' + n + '_nav"></li>').append(c);
      $(selector).append(l);
    });
    return true;
  }

  generateCatalog(".catalog-body");

  
  $(".catalog-toggle").click((function (e) {
    e.preventDefault();
    $('.side-catalog').toggleClass("fold")
  }))
</script>


<script type="text/javascript" src='/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js'></script>
<script>
   $(document).ready( function () {
    $('.catalog-body').onePageNav({
      currentClass: "active",
      changeHash: !1,
      easing: "swing",
      filter: "",
      scrollSpeed: 700,
      scrollOffset: 0,
      scrollThreshold: .2,
      begin: null,
      end: null,
      scrollChange: null,
      padding: 80
    });
  });
</script>









<script src="/zoomjs/zoom.min.js"></script>

</body>

</html>